name: TestMatrix

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  check-env:
    name: Compute outputs for use by other jobs
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        show-progress: false
    - name: Check whether tests need to be run based on diff
      uses: antrea-io/has-changes@v2
      id: check_diff
      with:
        paths-ignore: docs/* ci/jenkins/* *.md hack/.notableofcontents
    outputs:
      has_changes: ${{ steps.check_diff.outputs.has_changes }}

  test:
    needs: check-env
    if: ${{ needs.check-env.outputs.has_changes == 'yes' || github.event_name == 'push' }}
    strategy:
      matrix:
        include:
        - run: 1
          runner: ubuntu-latest
        - run: 2
          runner: ubuntu-latest
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Echo
        run: |
          echo "Run: ${{ matrix.run }}"

  test-status:
    needs: test
    if: ${{ always() }}
    runs-on: ubuntu-latest
    steps:
      - name: Success
        if: ${{ needs.test.result == 'success' }}
        run: |
          echo "Test was a success"
          exit 0
      - name: Skipped
        if: ${{ needs.test.result == 'skipped' }}
        run: |
          echo "Test was skipped"
          exit 0
      - name: Cancelled
        if: ${{ needs.test.result == 'cancelled' }}
        run: |
          echo "Test was cancelled"
          exit 1
      - name: Failure
        if: ${{ needs.test.result == 'failure' }}
        run: |
          echo "Test was a failure"
          exit 1
